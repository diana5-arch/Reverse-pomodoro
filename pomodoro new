import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, Square, Settings } from 'lucide-react';

export default function ReversePomodoro() {
  const [focusTime, setFocusTime] = useState(0);
  const [breakBank, setBreakBank] = useState(0);
  const [isFocusRunning, setIsFocusRunning] = useState(false);
  const [isBreakRunning, setIsBreakRunning] = useState(false);
  const [minutesPerHour, setMinutesPerHour] = useState(30);
  const [isEditingRatio, setIsEditingRatio] = useState(false);
  const [tempRatio, setTempRatio] = useState('30');
  const focusIntervalRef = useRef(null);
  const breakIntervalRef = useRef(null);

  // Focus Timer Effect
  useEffect(() => {
    if (isFocusRunning && !isBreakRunning) {
      focusIntervalRef.current = setInterval(() => {
        setFocusTime(prev => prev + 10);
        setBreakBank(prev => prev + (10 * minutesPerHour / 60));
      }, 10);
    } else {
      if (focusIntervalRef.current) {
        clearInterval(focusIntervalRef.current);
      }
    }

    return () => {
      if (focusIntervalRef.current) {
        clearInterval(focusIntervalRef.current);
      }
    };
  }, [isFocusRunning, isBreakRunning, minutesPerHour]);

  // Break Timer Effect
  useEffect(() => {
    if (isBreakRunning) {
      breakIntervalRef.current = setInterval(() => {
        setBreakBank(prev => {
          const newValue = prev - 10;
          if (newValue <= 0) {
            setIsBreakRunning(false);
            return 0;
          }
          return newValue;
        });
      }, 10);
    } else {
      if (breakIntervalRef.current) {
        clearInterval(breakIntervalRef.current);
      }
    }

    return () => {
      if (breakIntervalRef.current) {
        clearInterval(breakIntervalRef.current);
      }
    };
  }, [isBreakRunning]);

  const formatTime = (ms) => {
    const hours = Math.floor(ms / 3600000);
    const minutes = Math.floor((ms % 3600000) / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  };

  const formatBreakBank = (ms) => {
    const hours = Math.floor(ms / 3600000);
    const minutes = Math.floor((ms % 3600000) / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    const milliseconds = Math.floor(ms % 1000);
    return { hours, minutes, seconds, milliseconds };
  };

  const handleFocusStart = () => {
    setIsFocusRunning(true);
    setIsBreakRunning(false);
  };
  
  const handleFocusPause = () => setIsFocusRunning(false);
  
  const handleFocusEnd = () => {
    setIsFocusRunning(false);
    setFocusTime(0);
    setBreakBank(0);
  };

  const handleBreakStart = () => {
    if (breakBank > 0) {
      setIsBreakRunning(true);
      setIsFocusRunning(false);
    }
  };
  
  const handleBreakPause = () => setIsBreakRunning(false);
  
  const handleBreakEnd = () => {
    setIsBreakRunning(false);
    setBreakBank(0);
  };

  const handleRatioEdit = () => {
    setIsEditingRatio(true);
    setTempRatio(String(minutesPerHour));
  };

  const handleRatioSave = () => {
    const newRatio = parseFloat(tempRatio);
    if (!isNaN(newRatio) && newRatio > 0 && newRatio <= 60) {
      setMinutesPerHour(newRatio);
    }
    setIsEditingRatio(false);
  };

  const handleRatioKeyPress = (e) => {
    if (e.key === 'Enter') {
      handleRatioSave();
    } else if (e.key === 'Escape') {
      setIsEditingRatio(false);
    }
  };

  const breakBankFormatted = formatBreakBank(breakBank);

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-8">
      <div className="w-full max-w-md space-y-12">
        
        {/* Focus Timer */}
        <div className="text-center space-y-6">
          <h2 className="text-sm uppercase tracking-widest text-gray-500">
            {isBreakRunning ? 'Focus Timer (Counting Down)' : 'Focus Timer'}
          </h2>
          <div className={`text-6xl font-light tabular-nums transition-colors ${isBreakRunning ? 'text-gray-400' : 'text-gray-900'}`}>
            {formatTime(focusTime)}
          </div>
          
          <div className="flex justify-center gap-4">
            <button
              onClick={handleFocusStart}
              disabled={isFocusRunning || isBreakRunning}
              className="p-4 rounded-full bg-gray-900 text-white disabled:opacity-30 disabled:cursor-not-allowed hover:bg-gray-800 transition"
            >
              <Play size={24} />
            </button>
            <button
              onClick={handleFocusPause}
              disabled={!isFocusRunning}
              className="p-4 rounded-full bg-gray-900 text-white disabled:opacity-30 disabled:cursor-not-allowed hover:bg-gray-800 transition"
            >
              <Pause size={24} />
            </button>
            <button
              onClick={handleFocusEnd}
              className="p-4 rounded-full bg-gray-900 text-white hover:bg-gray-800 transition"
            >
              <Square size={24} />
            </button>
          </div>
        </div>

        {/* Divider */}
        <div className="border-t border-gray-300"></div>

        {/* Break Bank */}
        <div className="text-center space-y-6">
          <h2 className="text-sm uppercase tracking-widest text-gray-500">Break Bank</h2>
          <div className="flex justify-center gap-8">
            <div className="text-center">
              <div className="text-4xl font-light text-gray-900 tabular-nums">
                {String(breakBankFormatted.hours).padStart(2, '0')}
              </div>
              <div className="text-xs text-gray-500 mt-1">HOURS</div>
            </div>
            <div className="text-center">
              <div className="text-4xl font-light text-gray-900 tabular-nums">
                {String(breakBankFormatted.minutes).padStart(2, '0')}
              </div>
              <div className="text-xs text-gray-500 mt-1">MINUTES</div>
            </div>
            <div className="text-center">
              <div className="text-4xl font-light text-gray-900 tabular-nums">
                {String(breakBankFormatted.seconds).padStart(2, '0')}
              </div>
              <div className="text-xs text-gray-500 mt-1">SECONDS</div>
            </div>
            <div className="text-center">
              <div className="text-4xl font-light text-gray-900 tabular-nums">
                {String(breakBankFormatted.milliseconds).padStart(3, '0')}
              </div>
              <div className="text-xs text-gray-500 mt-1">MS</div>
            </div>
          </div>
          
          {/* Break Bank Controls */}
          <div className="flex justify-center gap-4">
            <button
              onClick={handleBreakStart}
              disabled={isBreakRunning || breakBank <= 0}
              className="p-4 rounded-full bg-gray-900 text-white disabled:opacity-30 disabled:cursor-not-allowed hover:bg-gray-800 transition"
            >
              <Play size={24} />
            </button>
            <button
              onClick={handleBreakPause}
              disabled={!isBreakRunning}
              className="p-4 rounded-full bg-gray-900 text-white disabled:opacity-30 disabled:cursor-not-allowed hover:bg-gray-800 transition"
            >
              <Pause size={24} />
            </button>
            <button
              onClick={handleBreakEnd}
              className="p-4 rounded-full bg-gray-900 text-white hover:bg-gray-800 transition"
            >
              <Square size={24} />
            </button>
          </div>

          {/* Editable Ratio */}
          <div className="flex items-center justify-center gap-2">
            {isEditingRatio ? (
              <div className="flex items-center gap-2">
                <span className="text-xs text-gray-400">+</span>
                <input
                  type="number"
                  value={tempRatio}
                  onChange={(e) => setTempRatio(e.target.value)}
                  onBlur={handleRatioSave}
                  onKeyDown={handleRatioKeyPress}
                  className="w-16 px-2 py-1 text-xs text-center border border-gray-300 rounded focus:outline-none focus:border-gray-900"
                  autoFocus
                  min="0.1"
                  max="60"
                  step="0.1"
                />
                <span className="text-xs text-gray-400">minutes per hour focused</span>
              </div>
            ) : (
              <button
                onClick={handleRatioEdit}
                className="flex items-center gap-2 text-xs text-gray-400 hover:text-gray-600 transition"
              >
                <span>+{minutesPerHour} minutes per hour focused</span>
                <Settings size={14} />
              </button>
            )}
          </div>
        </div>

      </div>
    </div>
  );
}
